@section Scripts {
    <script type="text/javascript" src="@Url.Content("~/Scripts/knockout-2.2.0.js")"></script>
    <script type="text/javascript">

    function AppViewModel() {
        var self = this;
        self.loggedIn = @(Request.IsAuthenticated ? "true" : "false");
        self.products = ko.observableArray();
//        self.cart = ko.observableArray();
        self.orders = ko.observableArray();
        self.details = ko.observable();

        function ProductViewModel(root, product) {
            var self = this;
            self.ProductId = product.Id;
            self.Name = product.Name;
            self.PageCount = product.PageCount;
            self.Quantity = ko.observable(0);

//            self.addItemToCart = function () {
//                var qty = self.Quantity();
//                if (qty == 0) {
//                    root.cart.push(self);
//                }
//                self.Quantity(qty + 1);
//            };
//
//            self.removeAllFromCart = function () {
//                self.Quantity(0);
//                root.cart.remove(self);
//            };
        }

        function OrderDetailsViewModel(order) {
            var self = this;
            self.items = ko.observableArray();
            self.Id = order.Id;

            self.total = ko.computed(function () {
                var sum = 0;
                $.each(self.items(), function (index, item) {
                    sum += item.Price * item.Quantity;
                });
                return '$' + sum.toFixed(2);
            });

            $.getJSON("/api/orders/" + order.Id, function (order) {
                $.each(order.Details, function(index, item) {
                    self.items.push(item);
                });
            });
        };

        self.resetCart = function() {
            var items = self.cart.removeAll();
            $.each(items, function(index, product) {
                product.Quantity(0);
            });
        };

        self.getDetails = function(order) {
            self.details(new OrderDetailsViewModel(order));
        };

        self.createOrder = function () {
            var jqxhr = $.ajax({
                type: 'POST',
                url: "api/orders",
                contentType: 'application/json; charset=utf-8',
                data: ko.toJSON({ Details: self.cart }),
                dataType: "json",
                success: function (newOrder) {
                    self.resetCart();
                    self.orders.push(newOrder);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    self.errorMessage(errorThrown);
                }  
            });
        };

        $.getJSON("/api/products", function (products) {
            $.each(products, function(index, product) {
                self.products.push(new ProductViewModel(self, product));
            });
        });

        $.getJSON("api/orders", self.orders);
    };

    $(document).ready(function () {
        ko.applyBindings(new AppViewModel());
    });

    </script>
}

<div class="content">
    <!-- List of products -->
    <div class="float-left">
        <h1>Books</h1>
        <ul id="products" data-bind="foreach: products">
            <li>
                <div>
                    <span data-bind="text: Name"></span>
                    <span class="price" data-bind="text: '总页数' + PageCount"></span>
                </div>
            </li>
        </ul>
    </div>
</div>